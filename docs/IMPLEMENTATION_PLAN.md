# **Technical Design Document: Secure Coding Exam Platform**

## **1\. System Architecture & Core Stack**

### **Frontend & Framework**

* **Framework:** Next.js 15+ (App Router).  
* **Language:** TypeScript (Strict Mode required).  
* **UI Components:** Shadcn UI (Tailwind CSS \+ Radix Primitives).  
* **State Management:**  
  * *Server:* React Server Components (RSC) & Server Actions.  
  * *Client (Global):* React Context (for ExamSessionContext \- timer, active questions).  
  * *Client (URL):* nuqs (Type-safe search params for tab management/question navigation).  
* **Code Editor:** @uiw/react-codemirror (Configured strictly for Java).  
* **Validation:** zod \+ react-hook-form.

### **Backend & Data**

* **Database:** PostgreSQL.  
* **ORM:** Drizzle ORM.  
* **Authentication:** Better Auth (Self-hosted).  
  * *Strategy:* Email/Password (Admin-seeded only).  
  * *Session:* HTTP-only Cookies.  
* **Code Execution Engine:** "Turbo Engine" (External/Internal API).  
  * *Integration:* Adapter pattern via lib/turbo.ts.

### **Infrastructure**

* **Routing/Proxy:** proxy.ts (Middleware logic to guard exam routes).  
* **User Provisioning:** CLI/TUI (Terminal User Interface) via Node.js scripts.

## **2\. Database Schema Design (PostgreSQL \+ Drizzle)**

### **users (Managed by Better Auth)**

Standard tables (user, session, account, verification) generated by Better Auth.

* **Constraint:** Public registration is disabled.

### **exams**

Defines the meta-data for a scheduled test event.

| Column | Type | Description |
| :---- | :---- | :---- |
| id | UUID | Primary Key |
| title | Text | E.g., "Midterm Java Assessment" |
| description | Text | Markdown supported instructions |
| start\_time | Timestamp | Global start window |
| end\_time | Timestamp | Global end window |
| duration\_minutes | Integer | E.g., 90 minutes |
| status | Enum | upcoming, active, ended |

### **questions**

The bank of all possible problems.

| Column | Type | Description |
| :---- | :---- | :---- |
| id | UUID | Primary Key |
| title | Text | Short identifier |
| problem\_statement | Text | Markdown content |
| difficulty | Enum | easy, medium, hard |
| constraints | Text | Memory/Time limits displayed to user |
| allowed\_languages | JSON | Default: \["java"\] |

### **test\_cases**

linked to questions (1:N).

| Column | Type | Description |
| :---- | :---- | :---- |
| id | UUID | Primary Key |
| question\_id | UUID | Foreign Key \-\> questions.id |
| input | Text | CLI arguments or STDIN |
| expected\_output | Text | Expected STDOUT |
| is\_hidden | Boolean | true \= for grading, false \= sample case |

### **exam\_assignments**

**Crucial Table.** Stores the specific randomization for a user.

| Column | Type | Description |
| :---- | :---- | :---- |
| id | UUID | Primary Key |
| user\_id | UUID | Foreign Key \-\> users.id |
| exam\_id | UUID | Foreign Key \-\> exams.id |
| assigned\_question\_ids | JSONB | Array of 3 UUIDs \['uuid-1', 'uuid-2', 'uuid-3'\] |
| status | Enum | not\_started, in\_progress, completed |
| score | Integer | Calculated: 0, 20, 40, or 50 |
| started\_at | Timestamp | Set when user clicks "Enter Exam" |
| completed\_at | Timestamp | Set on auto-submit or manual finish |

**Performance & Indexing Strategy:**

* CREATE INDEX idx\_exam\_assignments\_user\_exam ON exam\_assignments (user\_id, exam\_id); (Speed up assignment lookups)  
* CREATE INDEX idx\_questions\_difficulty ON questions (difficulty); (Optimize randomization queries)

### **submissions**

Log of every code run attempt.

| Column | Type | Description |
| :---- | :---- | :---- |
| id | UUID | Primary Key |
| assignment\_id | UUID | FK \-\> exam\_assignments.id |
| question\_id | UUID | FK \-\> questions.id |
| code | Text | The Java code submitted |
| verdict | Enum | passed, failed, compile\_error, runtime\_error |
| test\_cases\_passed | Integer | Count of hidden cases passed |
| created\_at | Timestamp | Default: now() |

## **3\. Detailed Feature Specifications**

### **A. Authentication & TUI (The Admin Layer)**

Since there is no registration page, user management happens via CLI.

* **Script:** scripts/create-user.ts  
* **Libraries:** inquirer (for prompts), Better Auth internal hashing utilities.  
* **Flow:**  
  1. Admin runs npm run user:create.  
  2. Prompts: Name, Email, Password.  
  3. Script hashes password and performs a direct SQL INSERT into the user table.

### **B. Route Protection (Middleware)**

* **File:** middleware.ts (or src/proxy.ts depending on structure).  
* **Logic:**  
  * Matcher: /exams/:path\*  
  * Check: Valid Better Auth session cookie.  
  * Failure: Redirect to /auth/sign-in?callbackUrl=...  
  * Success: Allow request to proceed.

### **C. Onboarding & Fullscreen Enforcement**

* **Route:** /exams/\[examId\]/onboarding  
* **UX/UI:**  
  * Displays rules (Java only, No tab switching).  
  * **Primary Action:** "Enter Exam" (Button).  
* **Logic:**  
  1. User clicks button.  
  2. Browser triggers document.documentElement.requestFullscreen().  
  3. **Only** inside the Promise resolution of the fullscreen request does the router push to /exams/\[examId\]/session.  
  4. **Event Listener:** fullscreenchange. If user exits fullscreen, trigger a modal warning: "Returning to windowed mode will log an incident. Please re-enter fullscreen."

### **D. The "Randomizer" Engine**

* **Trigger:** Server Action initializeExamSession(examId) called during onboarding.  
* **Algorithm:**  
  1. **Idempotency Check:** Query exam\_assignments for existing record where user\_id \= Current User AND exam\_id \= Target Exam. If found, return immediate state.  
  2. If new:  
     * Fetch all questions linked to the exam (or all global questions if generic).  
     * Use SQL ORDER BY RANDOM() LIMIT 3 (Postgres) or shuffled.slice(0,3) (JS) to select questions.  
  3. **Transaction:** Insert into exam\_assignments with started\_at \= now() and assigned\_question\_ids.  
  4. Return the Question IDs to the client.

### **E. Scoring System (20-40-50 Rule)**

This logic runs purely on the backend after a successful submission.

* **Trigger:** User passes all test cases for a specific question.  
* **Calculation:**  
  1. Fetch all successful submissions for this assignment\_id, grouping by question\_id.  
  2. Let $N$ \= Count of unique questions solved (0, 1, 2, or 3).  
  3. **Apply Logic:**  
     * $N \= 0 \\rightarrow 0$ pts  
     * $N \= 1 \\rightarrow 20$ pts  
     * $N \= 2 \\rightarrow 40$ pts  
     * $N \= 3 \\rightarrow 50$ pts (Bonus logic)  
  4. Update exam\_assignments.score.  
  * *Note:* Score is monotonically increasing; retries do not decrease score.

### **F. Turbo Engine Integration**

* **Adapter:** lib/turbo.ts  
* **Function Signature:**  
  interface ExecutionResult {  
    status: 'success' | 'error';  
    output: string; // Stdout  
    error?: string; // Stderr or Compilation Error  
    testResults: Array\<{ input: string; expected: string; actual: string; passed: boolean }\>;  
  }

  async function executeCode(code: string, language: 'java', testCases: TestCase\[\]): Promise\<ExecutionResult\>

* **Implementation:** Sends payload to Turbo API. Handles timeouts (e.g., infinite loops in student code) gracefully.

### **G. Validation & Security Protocols**

**Data Validation (Zod):**

* **Submission Schema:**  
  const SubmitCodeSchema \= z.object({  
    examId: z.string().uuid(),  
    questionId: z.string().uuid(),  
    code: z.string().min(10, "Code is too short").max(10000, "Code exceeds limit"),  
    language: z.enum(\["java"\])  
  });

**Client-Side Security (Anti-Cheat):**

* **Clipboard Blocking:** Prevent copy and paste events on the CodeMirror instance to discourage pasting from external LLMs.  
* **Context Menu:** Disable right-click on the editor container.  
* **Focus Tracking:** Log window.onblur events to track if the user is switching windows/tabs, even if they remain in fullscreen.

## **4\. Implementation Roadmap**

### **Phase 1: Core Infrastructure & Database**

1. **Project Init:** npx create-next-app@latest (TS, Tailwind, ESLint).  
2. **UI Library:** Initialize Shadcn UI and install core primitives (Button, Card, Dialog, Toast).  
3. **Database:** Setup Drizzle ORM with PostgreSQL.  
4. **Schema:** Define users, exams, questions tables and run initial migrations.

### **Phase 2: Authentication & The "Hidden" Admin**

1. **Better Auth Setup:** Configure the auth server and client.  
2. **CLI Tools:** Build scripts/create-user.ts (inquirer \+ hashing) to seed admin/student users.  
3. **Seed Data:** Create scripts/seed-questions.ts to bulk insert questions and test cases.

### **Phase 3: Dashboard & Route Security**

1. **Login Page:** Build /auth/sign-in with Zod validation.  
2. **Exam Listing:** Create the dashboard (/exams) fetching data from the exams table.  
3. **Middleware:** Implement proxy.ts to protect /exams/\* routes.  
4. **Layouts:** Create the global dashboard shell (Header, UserDropdown).

### **Phase 4: Session Logic & Randomization**

*Focus on the "Start Exam" flow, excluding the code editor.*

1. **Onboarding UI:** Build the rules page with the "Enter Fullscreen" trigger.  
2. **Server Action:** Implement initializeExamSession(examId).  
   * Handle the logic: "If exists, return. If new, randomize & insert."  
3. **Context:** Create ExamSessionContext to manage the session timer and active question state.

### **Phase 5: The IDE Interface (Frontend Only)**

*Focus on the complex UI components.*

1. **Layout:** Implement the 3-panel resizable layout (Sidebar, Problem, Editor/Console).  
2. **Editor:** Configure @uiw/react-codemirror with Java syntax highlighting.  
3. **Navigation:** Use nuqs to handle switching between Question 1, 2, and 3 via URL params.  
4. **Tabs:** Build the "Test Cases" vs "Console Output" toggle system.

### **Phase 6: Code Execution Pipeline**

*Focus on the "Run" button.* Refer to `docs/TURBO_API_REFERENCE.md` for more details.

1. **Turbo Adapter:** Implement lib/turbo.ts to handle API requests to the execution engine.  
2. **API Route:** Create a robust Server Action runCode(code, language, inputs) that calls the adapter.  
3. **Response Handling:** Parse stdout/stderr and display it in the "Console Output" tab.

### **Phase 7: Submission & Scoring Logic**

*Focus on the "Submit" button and grading.*

1. **Submission Action:** Implement submitQuestion(assignmentId, code).  
2. **Grading Logic:** Run code against *Hidden* test cases.  
3. **Scoring Algorithm:** Implement the "20-40-50" rule calculation in a DB transaction.  
4. **Feedback:** Update the sidebar (green checkmarks) and exam\_assignments.score in real-time.

### **Phase 8: Security & Final Polish**

1. **Anti-Cheat:**  
   * Attach fullscreenchange listeners.  
   * Disable contextmenu (Right-click) and onCopy/onPaste in the editor.  
2. **Hardening:** Add Rate Limiting to the "Run Code" button to prevent API abuse.  
3. **Auto-Submit:** Implement the forceful redirect when the timer hits 0\.  
4. **Results Page:** Build the final summary view showing the calculated score.